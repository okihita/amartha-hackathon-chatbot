<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Majelis - Amartha Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div id="header-placeholder"></div>
        
        <div class="card">
            <div class="card-header-actions">
                <h2>Majelis Groups</h2>
                <button class="btn btn-primary" onclick="openCreateModal()">+ Create Majelis</button>
            </div>
            
            <div id="loading" class="loading">Loading...</div>
            <div id="majelisGrid" class="majelis-grid" style="display: none;"></div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="majelisModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Create Majelis</h2>
            <form id="majelisForm">
                <input type="hidden" id="majelisId">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="majelisName" required placeholder="e.g., Majelis Sragen A">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="majelisDescription" placeholder="Optional description"></textarea>
                </div>
                <div class="form-group">
                    <label>Schedule Day *</label>
                    <select id="majelisDay" required>
                        <option value="">Select day</option>
                        <option value="Senin">Senin</option>
                        <option value="Selasa">Selasa</option>
                        <option value="Rabu">Rabu</option>
                        <option value="Kamis">Kamis</option>
                        <option value="Jumat">Jumat</option>
                        <option value="Sabtu">Sabtu</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Schedule Time</label>
                    <input type="time" id="majelisTime" value="10:00">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="majelisLocation" placeholder="e.g., Balai Desa Sragen">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Members Modal -->
    <div id="membersModal" class="modal">
        <div class="modal-content">
            <h2>Add/Remove Members</h2>
            <p id="membersModalTitle" class="modal-subtitle"></p>
            
            <div class="form-group">
                <label>Add Member (Search by name or phone)</label>
                <div class="search-input-group">
                    <div class="search-input-wrapper">
                        <input type="text" id="newMemberPhone" placeholder="Type to search..." autocomplete="off" oninput="filterUsers(this.value)">
                        <div id="userSuggestions" class="user-suggestions"></div>
                    </div>
                    <button class="btn btn-success" onclick="addMember()">Add</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Current Members</label>
                <div id="memberList" class="member-list"></div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeMembersModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let currentMajelisId = null;
        let allUsers = [];

        async function fetchMajelis() {
            try {
                const res = await fetch('/api/majelis');
                const majelis = await res.json();
                renderMajelis(majelis);
            } catch (error) {
                console.error('Failed to fetch majelis', error);
                document.getElementById('loading').textContent = 'Error loading majelis';
            }
        }

        async function fetchUsers() {
            try {
                const res = await fetch('/api/users');
                allUsers = await res.json();
            } catch (error) {
                console.error('Failed to fetch users', error);
            }
        }

        function renderMajelis(majelis) {
            const grid = document.getElementById('majelisGrid');
            const loading = document.getElementById('loading');
            
            loading.style.display = 'none';
            grid.style.display = 'grid';
            
            if (majelis.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>No majelis yet. Create one!</p></div>';
                return;
            }
            
            grid.innerHTML = majelis.map(m => {
                const memberCount = m.members?.length || 0;
                const membersList = m.members?.map(phone => {
                    const user = allUsers.find(u => u.phone === phone);
                    if (user) {
                        return `
                            <div class="member-item-inline">
                                <span class="member-name">${user.name}</span>
                                <span class="member-details"> ‚Ä¢ ${user.business_type}</span>
                            </div>
                        `;
                    }
                    return `<div class="member-item-inline"><span class="member-name">${phone}</span></div>`;
                }).join('') || '<div class="no-members">üì≠ No members yet. Click "Add Member" to get started.</div>';
                
                return `
                <div class="majelis-card">
                    <h3>${m.name}</h3>
                    <div class="info-row">
                        <span>üìÖ ${m.schedule_day} ${m.schedule_time}</span>
                        <span>üìç ${m.location || 'No location'}</span>
                    </div>
                    ${m.description ? `<p class="majelis-description">${m.description}</p>` : ''}
                    <div class="member-count">üë• ${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
                    <div class="member-list">${membersList}</div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="openMembersModal('${m.id}', '${m.name}')">+ Add Member</button>
                        <button class="btn btn-secondary" onclick="openEditModal('${m.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteMajelis('${m.id}', '${m.name}')">Delete</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create Majelis';
            document.getElementById('majelisForm').reset();
            document.getElementById('majelisId').value = '';
            document.getElementById('majelisModal').classList.add('active');
        }

        async function openEditModal(id) {
            try {
                const res = await fetch(`/api/majelis/${id}`);
                const majelis = await res.json();
                
                document.getElementById('modalTitle').textContent = 'Edit Majelis';
                document.getElementById('majelisId').value = id;
                document.getElementById('majelisName').value = majelis.name;
                document.getElementById('majelisDescription').value = majelis.description || '';
                document.getElementById('majelisDay').value = majelis.schedule_day;
                document.getElementById('majelisTime').value = majelis.schedule_time;
                document.getElementById('majelisLocation').value = majelis.location || '';
                document.getElementById('majelisModal').classList.add('active');
            } catch (error) {
                alert('Failed to load majelis');
            }
        }

        function closeModal() {
            document.getElementById('majelisModal').classList.remove('active');
        }

        document.getElementById('majelisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('majelisId').value;
            const data = {
                name: document.getElementById('majelisName').value,
                description: document.getElementById('majelisDescription').value,
                schedule_day: document.getElementById('majelisDay').value,
                schedule_time: document.getElementById('majelisTime').value,
                location: document.getElementById('majelisLocation').value,
            };
            
            try {
                if (id) {
                    await fetch(`/api/majelis/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    await fetch('/api/majelis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                closeModal();
                await fetchMajelis();
            } catch (error) {
                alert('Failed to save majelis');
            }
        });

        async function deleteMajelis(id, name) {
            if (!confirm(`Delete ${name}?`)) return;
            
            try {
                await fetch(`/api/majelis/${id}`, { method: 'DELETE' });
                await fetchMajelis();
            } catch (error) {
                alert('Failed to delete majelis');
            }
        }

        async function openMembersModal(id, name) {
            currentMajelisId = id;
            document.getElementById('membersModalTitle').textContent = name;
            document.getElementById('membersModal').classList.add('active');
            await loadMembers(id);
        }

        function closeMembersModal() {
            document.getElementById('membersModal').classList.remove('active');
            currentMajelisId = null;
        }

        async function loadMembers(id) {
            try {
                const res = await fetch(`/api/majelis/${id}`);
                const majelis = await res.json();
                
                const memberList = document.getElementById('memberList');
                if (!majelis.members || majelis.members.length === 0) {
                    memberList.innerHTML = '<p class="empty-state">No members yet</p>';
                    return;
                }
                
                memberList.innerHTML = majelis.members.map(phone => {
                    const user = allUsers.find(u => u.phone === phone);
                    const name = user ? user.name : phone;
                    return `
                        <div class="member-item">
                            <span>${name} (${phone})</span>
                            <button class="btn btn-danger btn-sm" onclick="removeMember('${phone}')">Remove</button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load members', error);
            }
        }

        function filterUsers(query) {
            const suggestions = document.getElementById('userSuggestions');
            
            if (!query || query.length < 2) {
                suggestions.style.display = 'none';
                return;
            }
            
            const lowerQuery = query.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.is_verified && // Only show verified users
                (u.name.toLowerCase().includes(lowerQuery) || 
                 u.phone.includes(query))
            );
            
            if (filtered.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            suggestions.innerHTML = filtered.slice(0, 5).map(user => `
                <div class="suggestion-item" onclick="selectUser('${user.phone}', '${user.name}')">
                    <div class="name">${user.name}</div>
                    <div class="details">${user.phone} ‚Ä¢ ${user.business_type}</div>
                </div>
            `).join('');
            suggestions.style.display = 'block';
        }
        
        function selectUser(phone, name) {
            document.getElementById('newMemberPhone').value = phone;
            document.getElementById('userSuggestions').style.display = 'none';
        }
        
        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#newMemberPhone') && !e.target.closest('#userSuggestions')) {
                document.getElementById('userSuggestions').style.display = 'none';
            }
        });

        async function addMember() {
            const phone = document.getElementById('newMemberPhone').value.trim();
            if (!phone) {
                alert('Please enter a phone number');
                return;
            }
            
            try {
                const res = await fetch(`/api/majelis/${currentMajelisId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    if (data.error && data.error.includes('already belongs')) {
                        alert('User already belongs to another Majelis. Please remove them from their current Majelis first.');
                    } else {
                        alert(data.error || 'Failed to add member');
                    }
                    return;
                }
                
                document.getElementById('newMemberPhone').value = '';
                document.getElementById('userSuggestions').style.display = 'none';
                await loadMembers(currentMajelisId);
                await fetchMajelis();
            } catch (error) {
                alert('Failed to add member');
            }
        }

        async function removeMember(phone) {
            if (!confirm(`Remove ${phone} from this majelis?`)) return;
            
            try {
                await fetch(`/api/majelis/${currentMajelisId}/members/${phone}`, {
                    method: 'DELETE'
                });
                await loadMembers(currentMajelisId);
                await fetchMajelis();
            } catch (error) {
                alert('Failed to remove member');
            }
        }

        // Load data on page load
        fetchUsers();
        fetchMajelis();
    </script>
    
    <!-- Load layout and initialize -->
    <script src="/layout.js"></script>
    <script>
        document.getElementById('header-placeholder').innerHTML = renderHeader('majelis');
    </script>
</body>
</html>
