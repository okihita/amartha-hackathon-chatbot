<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Types - Amartha Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Business Types specific styles */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stats .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
        .stats .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stats .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; color: white; background: none; -webkit-text-fill-color: white; }
        .stats .stat-label { font-size: 14px; opacity: 0.9; color: white; }
        .empty-state code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 13px; }
        
        /* Business detail modal */
        .level-section { margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007bff; }
        .level-section h3 { color: #007bff; margin-bottom: 15px; }
        .level-section h4 { font-size: 14px; color: #666; margin-top: 15px; margin-bottom: 8px; text-transform: uppercase; }
        .level-section ul { margin-left: 20px; }
        .level-section li { margin-bottom: 5px; font-size: 14px; color: #333; line-height: 1.5; }
        .swot-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 10px; }
        .swot-box { padding: 15px; border-radius: 6px; }
        .swot-box.strengths { background: #d4edda; border-left: 4px solid #28a745; }
        .swot-box.weaknesses { background: #f8d7da; border-left: 4px solid #dc3545; }
        .swot-box.opportunities { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .swot-box.threats { background: #fff3cd; border-left: 4px solid #ffc107; }
        .swot-box h5 { font-size: 13px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; }
        .swot-box ul { margin-left: 15px; }
        .swot-box li { font-size: 13px; margin-bottom: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="header-placeholder"></div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total Business Types</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value" id="lastUpdated">‚Äî</div>
                <div class="stat-label">Last Updated</div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìö Business Classifications & Maturity Levels</h2>
            <div id="loading" class="loading">Loading business types...</div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üì¶</div>
                <h3>No Business Types Found</h3>
                <p>
                    Business classifications haven't been imported yet.<br><br>
                    To import from Google Drive, run:<br>
                    <code>node scripts/fetch-from-google-drive.js</code>
                </p>
            </div>
            <div id="businessGrid" class="business-grid" style="display: none;"></div>
        </div>
    </div>

    <!-- Business Detail Modal -->
    <div id="businessModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let allBusinessTypes = [];

        // Map business types to representative icons
        function getBusinessIcon(businessType) {
            const type = businessType.toLowerCase();
            
            // Food & Beverage
            if (type.includes('warung sembako') || type.includes('kelontong')) return 'üè™';
            if (type.includes('warung makan')) return 'üçΩÔ∏è';
            if (type.includes('coffee')) return '‚òï';
            if (type.includes('jajanan') || type.includes('camilan')) return 'üç™';
            if (type.includes('minuman')) return 'üßã';
            
            // Fashion & Retail
            if (type.includes('fashion') || type.includes('hijab')) return 'üëó';
            if (type.includes('elektronik') || type.includes('gadget')) return 'üì±';
            if (type.includes('pet shop')) return 'üêæ';
            if (type.includes('bahan bangunan')) return 'üß±';
            if (type.includes('mainan') || type.includes('hobi')) return 'üéÆ';
            
            // Services
            if (type.includes('laundry')) return 'üëï';
            if (type.includes('bengkel motor')) return 'üèçÔ∏è';
            if (type.includes('kecantikan') || type.includes('salon')) return 'üíá';
            if (type.includes('penjahit') || type.includes('permak')) return '‚úÇÔ∏è';
            if (type.includes('kos-kosan') || type.includes('penginapan')) return 'üè†';
            if (type.includes('logistik') || type.includes('ekspedisi')) return 'üì¶';
            if (type.includes('sewa kendaraan')) return 'üöó';
            if (type.includes('cuci steam') || type.includes('detailing')) return 'üöø';
            if (type.includes('apotek') || type.includes('obat')) return 'üíä';
            if (type.includes('event') || type.includes('wedding')) return 'üéâ';
            if (type.includes('bengkel las') || type.includes('bubut')) return 'üîß';
            if (type.includes('kontraktor') || type.includes('renovasi')) return 'üèóÔ∏è';
            
            // Agriculture
            if (type.includes('kriya') || type.includes('kerajinan')) return 'üé®';
            if (type.includes('petani') || type.includes('holtikultura')) return 'üå±';
            if (type.includes('nelayan') || type.includes('ikan')) return 'üêü';
            
            return 'üè¢'; // Default
        }

        async function fetchBusinessTypes() {
            try {
                const res = await fetch('/api/business-types');
                allBusinessTypes = await res.json();
                
                if (allBusinessTypes.length === 0) {
                    showEmptyState();
                } else {
                    renderBusinessTypes(allBusinessTypes);
                    updateStats(allBusinessTypes);
                }
            } catch (error) {
                console.error('Failed to fetch business types', error);
                document.getElementById('loading').textContent = 'Error loading business types';
            }
        }

        function showEmptyState() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function updateStats(businessTypes) {
            document.getElementById('stats').style.display = 'grid';
            
            // Find most recent import
            const dates = businessTypes
                .map(bt => bt.imported_at || bt.modified_at)
                .filter(d => d)
                .sort()
                .reverse();
            
            // Format as yyyy-mm-dd
            let lastUpdate = '‚Äî';
            if (dates.length > 0) {
                const date = new Date(dates[0]);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                lastUpdate = `${year}-${month}-${day}`;
            }
            
            document.getElementById('totalCount').textContent = businessTypes.length;
            document.getElementById('lastUpdated').textContent = lastUpdate;
        }

        function renderBusinessTypes(businessTypes) {
            const grid = document.getElementById('businessGrid');
            const loading = document.getElementById('loading');
            
            loading.style.display = 'none';
            grid.style.display = 'grid';
            
            // Sort by category number
            const sorted = businessTypes.sort((a, b) => {
                const numA = a.category_number || 999;
                const numB = b.category_number || 999;
                return numA - numB;
            });
            
            grid.innerHTML = sorted.map(bt => {
                const categoryNum = bt.category_number ? `Kategori ${bt.category_number}` : 'Mikro';
                const icon = getBusinessIcon(bt.business_type);
                
                // Get goals from each level (up to 5 levels)
                const goals = (bt.maturity_levels || [])
                    .filter(level => level.goal)
                    .map(level => `<div class="goal-item">Level ${level.level}: ${level.goal}</div>`)
                    .join('');
                
                return `
                    <div class="business-card" onclick="viewBusinessDetail('${bt.id}')">
                        <div class="card-header">
                            <div class="card-icon">${icon}</div>
                            <div class="card-title-section">
                                <div class="category">${categoryNum}</div>
                                <h3>${bt.business_type}</h3>
                            </div>
                        </div>
                        ${goals ? `
                            <div class="goals">
                                <strong style="font-size: 11px; text-transform: uppercase; color: #007bff; display: block; margin-bottom: 8px;">Level Up Goals:</strong>
                                ${goals}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function viewBusinessDetail(businessId) {
            const business = allBusinessTypes.find(bt => bt.id === businessId);
            if (!business) {
                alert('Business type not found');
                return;
            }
            
            const levelsHtml = (business.maturity_levels || []).map(level => {
                const hasSwot = level.swot && (
                    level.swot.strengths?.length > 0 ||
                    level.swot.weaknesses?.length > 0 ||
                    level.swot.opportunities?.length > 0 ||
                    level.swot.threats?.length > 0
                );
                
                const swotHtml = hasSwot ? `
                    <h4>SWOT Analysis</h4>
                    <div class="swot-grid">
                        <div class="swot-box strengths">
                            <h5>üí™ Strengths (Kekuatan)</h5>
                            <ul>
                                ${level.swot.strengths?.length > 0 ? level.swot.strengths.map(s => `<li>${s}</li>`).join('') : '<li>No data</li>'}
                            </ul>
                            ${level.swot_actions?.strength_actions?.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #c3e6cb;">
                                    <strong style="font-size: 12px;">Cara Memanfaatkan:</strong>
                                    <ul style="margin-top: 5px;">
                                        ${level.swot_actions.strength_actions.map(a => `<li>${a}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        <div class="swot-box weaknesses">
                            <h5>‚ö†Ô∏è Weaknesses (Kelemahan)</h5>
                            <ul>
                                ${level.swot.weaknesses?.length > 0 ? level.swot.weaknesses.map(w => `<li>${w}</li>`).join('') : '<li>No data</li>'}
                            </ul>
                            ${level.swot_actions?.weakness_actions?.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #f5c6cb;">
                                    <strong style="font-size: 12px;">Cara Mengatasi:</strong>
                                    <ul style="margin-top: 5px;">
                                        ${level.swot_actions.weakness_actions.map(a => `<li>${a}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        <div class="swot-box opportunities">
                            <h5>üéØ Opportunities (Peluang)</h5>
                            <ul>
                                ${level.swot.opportunities?.length > 0 ? level.swot.opportunities.map(o => `<li>${o}</li>`).join('') : '<li>No data</li>'}
                            </ul>
                            ${level.swot_actions?.opportunity_actions?.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #bee5eb;">
                                    <strong style="font-size: 12px;">Cara Memanfaatkan:</strong>
                                    <ul style="margin-top: 5px;">
                                        ${level.swot_actions.opportunity_actions.map(a => `<li>${a}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        <div class="swot-box threats">
                            <h5>‚ö° Threats (Ancaman)</h5>
                            <ul>
                                ${level.swot.threats?.length > 0 ? level.swot.threats.map(t => `<li>${t}</li>`).join('') : '<li>No data</li>'}
                            </ul>
                            ${level.swot_actions?.threat_actions?.length > 0 ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ffeeba;">
                                    <strong style="font-size: 12px;">Cara Menghadapi:</strong>
                                    <ul style="margin-top: 5px;">
                                        ${level.swot_actions.threat_actions.map(a => `<li>${a}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : '';
                
                const roadmapHtml = level.roadmap && (level.roadmap.description || level.roadmap.kpis?.length > 0) ? `
                    <h4>üó∫Ô∏è Roadmap to Next Level</h4>
                    ${level.roadmap.description ? `
                        <p style="font-size: 14px; color: #666; margin-bottom: 10px; line-height: 1.6;">${level.roadmap.description}</p>
                    ` : ''}
                    ${level.roadmap.kpis?.length > 0 ? `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
                            <strong style="font-size: 13px; color: #333;">Key Performance Indicators (KPIs):</strong>
                            <ul style="margin-top: 10px;">
                                ${level.roadmap.kpis.map(kpi => `<li style="margin-bottom: 8px;">${kpi}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                ` : '';
                
                return `
                    <div class="level-section">
                        <h3>${level.name || 'Level ' + level.level}</h3>
                        
                        ${level.character && level.character.length > 0 ? `
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #1976d2;">
                                <strong style="font-size: 13px; color: #1565c0;">Potret Diagnostik (Character of This Level):</strong>
                                <ul style="margin-top: 10px; margin-left: 20px;">
                                    ${level.character.map(c => `<li style="font-size: 14px; color: #333; margin-bottom: 6px; line-height: 1.6;">${c}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${swotHtml}
                        
                        ${roadmapHtml}
                    </div>
                `;
            }).join('');
            
            const categoryLabel = business.category_number ? `Kategori ${business.category_number}` : 'Mikro';
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${business.business_type}</h2>
                <div style="margin-bottom: 20px;">
                    <span style="display: inline-block; padding: 6px 12px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 13px; font-weight: 600;">
                        ${categoryLabel}
                    </span>
                </div>
                ${business.business_character ? `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <strong style="font-size: 14px; color: #856404;">Business Character:</strong>
                        <p style="color: #856404; margin-top: 8px; line-height: 1.6; font-size: 14px;">${business.business_character}</p>
                    </div>
                ` : ''}
                ${levelsHtml || '<p style="color: #999; text-align: center; padding: 40px;">No maturity level data available</p>'}
            `;
            
            document.getElementById('businessModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('businessModal').classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('businessModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Load business types on page load
        fetchBusinessTypes();
    </script>
    
    <!-- Load layout and initialize -->
    <script src="/layout.js"></script>
    <script>
        document.getElementById('header-placeholder').innerHTML = renderHeader('business-types');
    </script>
</body>
</html>
