<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Types - Amartha Dashboard</title>
    <script src="/layout.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; color: #333; margin-bottom: 10px; }
        .nav { display: flex; gap: 15px; margin-top: 10px; }
        .nav a { padding: 8px 16px; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333; font-weight: 500; transition: all 0.2s; }
        .nav a:hover { background: #e0e0e0; }
        .nav a.active { background: #007bff; color: white; }
        .admin-badge { background: #f0f0f0; padding: 8px 16px; border-radius: 4px; font-size: 14px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #333; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
        .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .business-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .business-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; transition: all 0.2s; cursor: pointer; }
        .business-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .business-card h3 { font-size: 18px; color: #333; margin-bottom: 10px; }
        .business-card .category { display: inline-block; padding: 4px 12px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 10px; }
        .business-card .description { font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5; }
        .business-card .levels { font-size: 13px; color: #999; }
        .business-card .keywords { margin-top: 10px; }
        .keyword-tag { display: inline-block; padding: 3px 8px; background: #f5f5f5; border-radius: 4px; font-size: 11px; color: #666; margin-right: 5px; margin-top: 5px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-state h3 { font-size: 20px; color: #666; margin-bottom: 10px; }
        .empty-state p { font-size: 14px; line-height: 1.6; max-width: 500px; margin: 0 auto; }
        .empty-state code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 13px; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; margin: 40px auto; padding: 30px; border-radius: 8px; max-width: 800px; width: 90%; }
        .modal-content h2 { margin-bottom: 20px; color: #333; }
        .modal-close { float: right; font-size: 28px; font-weight: bold; color: #999; cursor: pointer; }
        .modal-close:hover { color: #333; }
        .level-section { margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #007bff; }
        .level-section h3 { color: #007bff; margin-bottom: 15px; }
        .level-section h4 { font-size: 14px; color: #666; margin-top: 15px; margin-bottom: 8px; text-transform: uppercase; }
        .level-section ul { margin-left: 20px; }
        .level-section li { margin-bottom: 5px; font-size: 14px; color: #333; line-height: 1.5; }
        .swot-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 10px; }
        .swot-box { padding: 15px; border-radius: 6px; }
        .swot-box.strengths { background: #d4edda; border-left: 4px solid #28a745; }
        .swot-box.weaknesses { background: #f8d7da; border-left: 4px solid #dc3545; }
        .swot-box.opportunities { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .swot-box.threats { background: #fff3cd; border-left: 4px solid #ffc107; }
        .swot-box h5 { font-size: 13px; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; }
        .swot-box ul { margin-left: 15px; }
        .swot-box li { font-size: 13px; margin-bottom: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üè¶ Amartha Admin Dashboard</h1>
                <div class="nav">
                    <a href="/">üë• Users</a>
                    <a href="/majelis">üìÖ Majelis</a>
                    <a href="/business-types" class="active">üè™ Business Types</a>
                </div>
            </div>
            <div class="admin-badge">Admin: <strong>Petugas Lapangan</strong></div>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total Business Types</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value" id="levelCount">0</div>
                <div class="stat-label">Total Maturity Levels</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-value" id="mikroCount">0</div>
                <div class="stat-label">Mikro Category</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-value" id="lastUpdated">‚Äî</div>
                <div class="stat-label">Last Updated</div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìö Business Classifications & Maturity Levels</h2>
            <div id="loading" class="loading">Loading business types...</div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üì¶</div>
                <h3>No Business Types Found</h3>
                <p>
                    Business classifications haven't been imported yet.<br><br>
                    To import from Google Drive, run:<br>
                    <code>node scripts/fetch-from-google-drive.js</code>
                </p>
            </div>
            <div id="businessGrid" class="business-grid" style="display: none;"></div>
        </div>
    </div>

    <!-- Business Detail Modal -->
    <div id="businessModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let allBusinessTypes = [];

        async function fetchBusinessTypes() {
            try {
                const res = await fetch('/api/business-types');
                allBusinessTypes = await res.json();
                
                if (allBusinessTypes.length === 0) {
                    showEmptyState();
                } else {
                    renderBusinessTypes(allBusinessTypes);
                    updateStats(allBusinessTypes);
                }
            } catch (error) {
                console.error('Failed to fetch business types', error);
                document.getElementById('loading').textContent = 'Error loading business types';
            }
        }

        function showEmptyState() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function updateStats(businessTypes) {
            document.getElementById('stats').style.display = 'grid';
            
            const totalLevels = businessTypes.reduce((sum, bt) => sum + (bt.levels?.length || 0), 0);
            const mikroCount = businessTypes.filter(bt => bt.legal_category === 'Mikro').length;
            
            // Find most recent update
            const dates = businessTypes
                .map(bt => bt.updated_at)
                .filter(d => d)
                .sort()
                .reverse();
            const lastUpdate = dates.length > 0 ? new Date(dates[0]).toLocaleDateString('id-ID') : '‚Äî';
            
            document.getElementById('totalCount').textContent = businessTypes.length;
            document.getElementById('levelCount').textContent = totalLevels;
            document.getElementById('mikroCount').textContent = mikroCount;
            document.getElementById('lastUpdated').textContent = lastUpdate;
        }

        function renderBusinessTypes(businessTypes) {
            const grid = document.getElementById('businessGrid');
            const loading = document.getElementById('loading');
            
            loading.style.display = 'none';
            grid.style.display = 'grid';
            
            grid.innerHTML = businessTypes.map(bt => {
                const levelCount = bt.levels?.length || 0;
                const keywords = bt.keywords?.slice(0, 5) || [];
                
                return `
                    <div class="business-card" onclick="viewBusinessDetail('${bt.id}')">
                        <div class="category">${bt.legal_category || 'Mikro'}</div>
                        <h3>${bt.business_type}</h3>
                        <div class="description">${bt.description || 'No description available'}</div>
                        <div class="levels">üìä ${levelCount} Maturity Levels</div>
                        <div class="keywords">
                            ${keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewBusinessDetail(businessId) {
            const business = allBusinessTypes.find(bt => bt.id === businessId);
            if (!business) {
                alert('Business type not found');
                return;
            }
            
            const levelsHtml = (business.levels || []).map(level => {
                const swotHtml = level.swot ? `
                    <h4>SWOT Analysis</h4>
                    <div class="swot-grid">
                        <div class="swot-box strengths">
                            <h5>üí™ Strengths</h5>
                            <ul>
                                ${level.swot.strengths?.map(s => `<li>${s}</li>`).join('') || '<li>No data</li>'}
                            </ul>
                        </div>
                        <div class="swot-box weaknesses">
                            <h5>‚ö†Ô∏è Weaknesses</h5>
                            <ul>
                                ${level.swot.weaknesses?.map(w => `<li>${w}</li>`).join('') || '<li>No data</li>'}
                            </ul>
                        </div>
                        <div class="swot-box opportunities">
                            <h5>üéØ Opportunities</h5>
                            <ul>
                                ${level.swot.opportunities?.map(o => `<li>${o}</li>`).join('') || '<li>No data</li>'}
                            </ul>
                        </div>
                        <div class="swot-box threats">
                            <h5>‚ö° Threats</h5>
                            <ul>
                                ${level.swot.threats?.map(t => `<li>${t}</li>`).join('') || '<li>No data</li>'}
                            </ul>
                        </div>
                    </div>
                ` : '';
                
                return `
                    <div class="level-section">
                        <h3>Level ${level.level}: ${level.name}</h3>
                        
                        ${level.criteria?.length > 0 ? `
                            <h4>üìã Criteria</h4>
                            <ul>
                                ${level.criteria.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        ` : ''}
                        
                        ${level.characteristics?.length > 0 ? `
                            <h4>üîç Characteristics</h4>
                            <ul>
                                ${level.characteristics.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        ` : ''}
                        
                        ${level.next_steps?.length > 0 ? `
                            <h4>‚û°Ô∏è Next Steps</h4>
                            <ul>
                                ${level.next_steps.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        ` : ''}
                        
                        ${swotHtml}
                        
                        ${level.recommended_actions?.length > 0 ? `
                            <h4>üí° Recommended Actions</h4>
                            <ul>
                                ${level.recommended_actions.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        ` : ''}
                        
                        ${level.estimated_duration ? `
                            <h4>‚è±Ô∏è Estimated Duration</h4>
                            <p style="font-size: 14px; color: #666;">${level.estimated_duration}</p>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('modalContent').innerHTML = `
                <h2>${business.business_type}</h2>
                <p style="color: #666; margin-bottom: 20px;">${business.description || ''}</p>
                <div style="margin-bottom: 20px;">
                    <span style="display: inline-block; padding: 6px 12px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 13px; font-weight: 600;">
                        ${business.legal_category || 'Mikro'}
                    </span>
                </div>
                ${levelsHtml}
            `;
            
            document.getElementById('businessModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('businessModal').classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('businessModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Load business types on page load
        fetchBusinessTypes();
    </script>
</body>
</html>
